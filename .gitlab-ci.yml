image: python:3.9

include:
    -   template: Code-Quality.gitlab-ci.yml

.testSetup: &testSetup
    stage: test
    allow_failure: true
    coverage: '/^TOTAL.*\s+(\d+\%)$/'
    script:
        - pip install ".[test]"
        - pytest --cov-report=term --cov=credmgr tests

stages:
    - lint
    - test
    - deploy
    - pages

black:
    stage: lint
    image: alpine
    except:
        refs:
            - master
            - dev
            - /v*/
    before_script:
        - apk --no-cache add py3-pip python3-dev gcc linux-headers musl-dev libffi-dev openssl-dev git
        - pip3 install black
    script:
        - black --check .
    allow_failure: false


test:pytest3.9:
    image: python:3.9
    <<: *testSetup

test:pytest3.8:
    image: python:3.8
    <<: *testSetup

test:pytest3.7:
    image: python:3.7
    <<: *testSetup

test:pytest3.6:
    image: python:3.6
    <<: *testSetup

deploy:
    stage: deploy
    variables:
        TWINE_USERNAME: $PYPI_USERNAME
        TWINE_PASSWORD: $PYPI_PASSWORD
    before_script:
        - pip install twine
        - python setup.py sdist
    script:
        - twine upload dist/*
    only:
        - tags

pages:
    script:
        - pip install .[docs]
        - cd docs ; make html
        - mv _build/html/ ../public/
    artifacts:
        paths:
            - public
    only:
        - tags
